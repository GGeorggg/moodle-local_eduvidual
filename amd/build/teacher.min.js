define(["jquery","core/ajax","core/notification","core/str","core/templates","core/url","local_eduvidual/main","local_eduvidual/user"],function(i,c,e,g,d,b,f,h){return{courseAction:function(k,l){console.log("TEACHER.courseAction(courseid, selectmenu)",k,l);var j=i(l).val();i(l).val("");require(["local_eduvidual/main"],function(m){switch(j){case"enrol":m.navigate(b.fileUrl("/local/eduvidual/pages/courses.php","")+"?act=enrol&id="+k);break;case"gradings":m.navigate(b.fileUrl("/grade/report/grader/index.php","")+"?id="+k);break;case"hideshow":m.connect({module:"teacher",act:"course_hideshow",courseid:k},{});break;case"remove":this.courseRemove(k);break}})},courseRemove:function(l,j){if(typeof j==="undefined"||!j){var k=this;g.get_strings([{key:"courseremove:title",component:"local_eduvidual"},{key:"courseremove:text",component:"local_eduvidual"},{key:"yes"},{key:"no"}]).done(function(m){e.confirm(m[0],m[1],m[2],m[3],function(){k.courseRemove(l,true)})}).fail(e.exception)}else{require(["local_eduvidual/main"],function(m){m.connect({module:"teacher",act:"course_remove",courseid:l},{})})}},createCourseSelections:function(m){var j=this;var q=+i("#"+m+"-orgid").val();var p=i("#"+m+"-subcat1").val();var n=i("#"+m+"-subcat2").val();var l=i("#"+m+"-subcat3").val();var o="local_eduvidual_teacher_createcourse_selections";var k={orgid:q,subcat1:p,subcat2:n,subcat3:l};console.log("Sending to ",o,k);require(["local_eduvidual/main"],function(r){r.spinnerGrid(true)});c.call([{methodname:o,args:k,done:function(s){require(["local_eduvidual/main"],function(y){y.spinnerGrid(false)});try{s=JSON.parse(s)}catch(v){}console.log("local_eduvidual_teacher_createcourse_selections",s);for(a=1;a<=4;a++){i("."+m+"-subcats"+a+"lbl").html(s["subcats"+a+"lbl"])}var r=[1,2,3,4];var u={1:true,2:false,3:false,4:false};var w={1:false,2:false,3:false,4:false};Object.keys(r).forEach(function(B){var A=r[B];var D="subcat"+A;var y="subcats"+A;var z="subcats"+A+"lbl";if(typeof s[z]!=="undefined"&&s[z]==""){i("#"+m+"-form ."+m+"-"+z).html("").closest("tr").css("display","none");w[A]=true}else{if(A<=2){u[A]=true}if(A==3&&w[2]){u[A]=true}if(A==4&&w[2]&&w[3]){u[A]=true}i("#"+m+"-form ."+m+"-"+z).html(s[z]).closest("tr").css("display","");if(typeof s[y]!=="undefined"){var E=i("#"+m+"-"+D);var C=E.parent();if(s[y]!==null&&s[y].length>0){if(!E.is("select")){E.remove();var E=i("<select>").attr("id",m+"-"+D).attr("name",D).attr("onchange","require(['local_eduvidual/teacher'], function(T) { T.createCourseSelections('"+m+"'); });").attr("style","width: 100%");C.append(E)}else{E.empty()}E.append(i("<option>").attr("value","").html("---"));Object.keys(s[y]).forEach(function(F){var G=i("<option>").attr("value",s[y][F]).html(s[y][F]);if(s[D]==s[y][F]){G.attr("selected","selected")}E.append(G)})}else{if(!E.is("input")){E.remove();var E=i("<input>").attr("id",m+"-"+D).attr("name",D).attr("onkeyup","require(['local_eduvidual/teacher'], function(T) { T.createCourseSelections('"+m+"'); });").attr("style","width: 100%").val(s[D]);C.append(E)}}console.log(E)}}});var t=false;i("#"+m+"-form table.generaltable tr").each(function(y,z){if(i(z).css("display")!="none"){t=!t;i(z).css("background-color",(t)?"rgba(0,0,0,0.05)":"#ffffff")}});var x=true;Object.keys(u).forEach(function(y){i("#"+m+"-form ."+m+"-subcat"+y+" td.requirement").html("");if(u[y]){console.log("Check ",y,i("#"+m+"-form #"+m+"-subcat"+y).val());if(i("#"+m+"-form #"+m+"-subcat"+y).val()==""){x=false}j.createCourseSelectionsRequired(i("#"+m+"-form ."+m+"-subcat"+y+" td.requirement"))}});if(!x){i("#"+m+"-submit").addClass("disabled")}else{i("#"+m+"-submit").removeClass("disabled")}},fail:e.exception}])},createCourseSelectionsRequired:function(j){d.render("local_eduvidual/teacher_createcourse_required",{}).then(function(k,l){i(j).html("");d.appendNodeContents(i(j),k,l)}).fail(function(k){})},createModule:function(){var k=+i("#local_eduvidual_teacher_createmodule").attr("data-orgid");var n=+i("#local_eduvidual_teacher_createmodule").attr("data-courseid");var r=+i("#local_eduvidual_teacher_createmodule").attr("data-sectionid");var t=this.module.id;var l={};var o=this.module.payload.customize;if(typeof o!=="undefined"){var s=Object.keys(o);for(var q=0;q<s.length;q++){var m=s[q];var p=o[m];var j="edublock_custom_"+m;l[m]=i("#"+j).val()}}l.course=n;l.section=r;require(["local_eduvidual/main"],function(u){u.connect({module:"teacher",act:"createmodule_create",orgid:k,moduleid:t,formdata:JSON.stringify(l)},{section:r})})},createModuleSearch:function(k){var j={};i("#"+k+"-createmoduleform").serializeArray().map(function(l){j[l.name]=l.value});j.module="teacher";j.act="createmodule_search";console.log(j);require(["local_eduvidual/main"],function(l){l.connect(j,{uniqid:k,sectionid:j.sectionid,courseid:j.courseid})})},loadCategory:function(j){if(this.debug>0){console.log("TEACHER.loadCategory(categoryid)",j)}var k=i("#local_eduvidual_teacher_createmodule").attr("data-orgid");require(["local_eduvidual/main"],function(l){l.connect({module:"teacher",act:"createmodule_category",orgid:k,categoryid:j})})},loadCourseCategory:function(j,k){if(typeof k==="undefined"){k=+i("#local_eduvidual_teacher_createcourse").attr("data-orgid")}require(["local_eduvidual/main"],function(l){l.connect({module:"teacher",act:"createcourse_category",orgid:k,categoryid:j})})},loadCourseForm:function(o){console.log("TEACHER.loadCourseForm(step)",o);if(typeof o==="undefined"){o=0}var n=+i(".ul-eduvidual-courses").attr("data-categoryid");var q=+i(".ul-eduvidual-courses").attr("data-orgid");if(q>0&&n>0&&o==0){o=1}switch(o){case 0:break;case 1:var k=i(".ul-eduvidual-courses").empty();var m=i("<div>").addClass("grid-eq-2").css("text-align","center");k.append(m);g.get_strings([{key:"back",component:"local_eduvidual"},{key:"create",component:"local_eduvidual"},{key:"createcourse:basement",component:"local_eduvidual"},{key:"createcourse:name",component:"local_eduvidual"},{key:"createcourse:nameinfo",component:"local_eduvidual"},{key:"createcourse:setteacher",component:"local_eduvidual"},{key:"filter",component:"core"},]).done(function(G){var z=i("<div>");var H=i("<a>").addClass("ui-btn btn btn-_secondary").attr("onclick",'require(["local_eduvidual/user"], function(USER) { USER.loadCategory('+(+i(".ul-eduvidual-courses").attr("data-categoryid"))+"); });").html(G[0]);H.html('<img src="/pix/t/left.svg" alt=""> '+H.html());z.append(H);var F=i("<a>").addClass("btn ui-btn").attr("href","#").attr("onclick",'require(["local_eduvidual/teacher"], function(TEACHER) { TEACHER.loadCourseForm(2); });').html(G[1]);m.append([z,F]);var w=i("<div>").addClass("grid-eq-2");k.append(w);var y=i("<div>");var u=i('<div class="div-right">');w.append([y,u]);var C=i("<label>").html(G[2]);var x=i('<select style="max-width: 100%;">').attr("onchange",'var sel = this; require(["local_eduvidual/teacher"], function(TEACHER) { TEACHER.loadCourseFormBasementInfo(sel.value); });').addClass("local_eduvidual_teacher_createcourse_basement");x.append("<option>").html("loading");var v=i("<label>").html(G[3]);var t=i("<p>").html(G[4]);var B=i("<input>").addClass("local_eduvidual_teacher_createcourse_name");y.append([C,x,v,B,t]);var A=i("<div>").addClass("local_eduvidual_teacher_createcourse_setteacher").css("display","none");var E=i("<p>").html(G[5]);var r=i("<input>").attr("placeholder",G[6]).attr("onkeyup",'var inp = this; require(["local_eduvidual/teacher"], function(TEACHER) { TEACHER.loadCourseTeacher('+q+", inp); });");var D=i("<select>");A.append([E,r,D]);k.append(A);require(["local_eduvidual/main"],function(s){s.connect({module:"teacher",act:"createcourse_basements",orgid:q},{signalItem:x})})}).fail(e.exception);break;case 2:var p=+i(".local_eduvidual_teacher_createcourse_basement").val();var l=i(".local_eduvidual_teacher_createcourse_name").val();var j=+i(".local_eduvidual_teacher_createcourse_setteacher select").val();require(["local_eduvidual/main"],function(r){r.connect({module:"teacher",act:"createcourse_now",orgid:q,categoryid:n,basement:p,name:l,setteacher:j},{signalItem:{}})});break}},loadCourseTeacher:function(l,k){var j=i(k).val();require(["local_eduvidual/main"],function(m){m.connect({module:"teacher",act:"createcourse_loadteacher",orgid:l,search:j},{signalItem:{}})})},loadCourseFormBasementInfo:function(o){var n=Object.keys(this.basements);var l=i(".ul-eduvidual-courses .div-right").empty();for(var k=0;k<n.length;k++){for(var j=0;j<this.basements[n[k]].length;j++){var q=this.basements[n[k]][j];if(q.id==o&&i(l).find("img").length==0){var r=i("<p>").html(q.summary).css("text-align","justify");if(q.imageurl!==""){var m=i("<img>").attr("src",q.imageurl).css("max-width","200px").css("width","25%").css("margin","0px 0px 5px 5px").css("float","right");r.prepend(m)}l.append(r)}}}},questioncategories:function(j){var k=[];i.each(i("input[name='questioncategories[]']:checked"),function(){k.push(+i(this).val())});require(["local_eduvidual/main"],function(l){l.connect({module:"user",act:"questioncategories",questioncategories:k},{signalItem:i(j).parent()})})},result:function(C){var v=this;if(C.data.act=="course_hideshow"){if(C.result.status=="ok"){history.go(0)}else{e.alert(C.result.error)}}if(C.data.act=="course_remove"){if(C.result.status=="ok"){history.go(-1)}else{e.alert(C.result.error)}}if(C.data.act=="createcourse_basements"){this.basements=C.result.basements;var r=Object.keys(C.result.basements);var y=i(".local_eduvidual_teacher_createcourse_basement").empty();var B=false;for(var K=0;K<r.length;K++){var q=i("<optgroup>").attr("label",r[K]);for(var J=0;J<C.result.basements[r[K]].length;J++){var l=C.result.basements[r[K]][J];var x=i("<option>").attr("value",l.id).html(l.fullname);q.append(x);if(!B){B=true;this.loadCourseFormBasementInfo(l.id)}}y.append(q)}if(C.result.canmanage){i(".local_eduvidual_teacher_createcourse_setteacher").css("display","block")}else{i(".local_eduvidual_teacher_createcourse_setteacher").css("display","block")}}if(C.data.act=="createcourse_category"){if(C.result.status=="ok"){var D=(typeof C.result.parent!=="undefined"&&C.result.parent.id>-1)?C.result.parent.id:-1;var z=i("#local_eduvidual_teacher_createcourse").empty();i("#local_eduvidual_teacher_createcourse_title").html(C.result.category.name);g.get_strings([{key:"back",component:"local_eduvidual"},{key:"createcourse:here",component:"local_eduvidual"},]).done(function(L){var p=i("<div>").addClass("form-inline felement").css("text-align","center").attr("data-fieldtype","group");var u=i("<div>").addClass("form-group fitem");var o=i("<div>").addClass("form-group fitem");var k=i("<a>").addClass("ui-btn btn btn-secondary").attr("onclick","history.go(-1);").html(L[0]);if(typeof D!=="undefined"&&D>0){k.attr("onclick",'require(["local_eduvidual/teacher"], function(TEACHER) { TEACHER.loadCourseCategory('+C.result.parent.id+"); });").html(C.result.parent.name)}k.html('<img src="/pix/t/left.svg" alt=""> '+k.html());var M=i("<a>").addClass("ui-btn btn btn-primary").attr("href","#").attr("onclick",'require(["local_eduvidual/teacher"], function(TEACHER) { TEACHER.loadCourseForm('+C.result.category.id+"); });").html('<img src="/pix/t/add.svg" alt=""> '+L[1]);u.append(k);o.append(M);p.append([u,o]);z.append(p)}).fail(e.exception);var w=i("<ul>").attr("data-role","listview").attr("data-inset","true").attr("data-filter","true").addClass("ui-listview ui-listview-inset ui-corner-all ui-shadow");if(typeof C.result.children!=="undefined"){var G=Object.keys(C.result.children);if(typeof C.result.children!=="undefined"&&G.length>0){for(var K=0;K<G.length;K++){var m=C.result.children[G[K]];var t=i("<li>").addClass("ui-li-has-count"+((K==(G.length-1))?" ui-last-child":""));var E=i("<a>").attr("href","#").attr("onclick",'require(["local_eduvidual/teacher"], function(TEACHER) { TEACHER.loadCourseCategory('+m.id+"); });");var n=i("<h3>").html(m.name);var A=i("<p>").html(m.description);E.append([n,A]);t.append(E);w.append(t)}}}z.append(w);try{i(w).trigger("create")}catch(I){}}}if(C.data.act=="createcourse_now"&&C.result.status=="ok"){require(["local_eduvidual/user"],function(k){k.loadCategory(C.data.categoryid,C.data.orgid)})}if(C.data.act=="createcourse_loadteacher"&&C.result.status=="ok"){var F=i(".local_eduvidual_teacher_createcourse_setteacher select").empty();for(var H=0;H<C.result.users.length;H++){var s=C.result.users[H];var x=i("<option>").attr("value",s.id).html(s.userfullname+"("+s.email+")");F.append(x)}}if(C.data.act=="user_search"){var j;if(i(C.payload.sender).attr("id")=="local_eduvidual_courses_courseusers_search"){j="#local_eduvidual_courses_courseusers"}if(i(C.payload.sender).attr("id")=="local_eduvidual_courses_orgusers_search"){j="#local_eduvidual_courses_orgusers"}if(typeof j==="undefined"){console.log(C.payload);e.alert("Unknown type of search")}else{if(C.result.users.length==0&&!C.payload.initialsearch){i(j).empty();i(j).append(i("<option>").html("no results"))}else{if(C.result.users.length>0){i(j).empty();for(var K=0;K<C.result.users.length;K++){i(j).append(i("<option>").attr("value",C.result.users[K].userid).html(C.result.users[K].name))}}}}}if(C.data.act=="user_set"){this.user_search("#local_eduvidual_courses_courseusers_search","courseusers",0)}},user_search:function(l,m,j){var o=+i("#local_eduvidual_courses").attr("data-orgid");var n=+i("#local_eduvidual_courses").attr("data-courseid");var k=i(l).val();require(["local_eduvidual/main"],function(p){p.connect({module:"teacher",act:"user_search",orgid:o,courseid:n,type:m,searchfor:k},{sender:l,initialsearch:j})})},user_set:function(k,l){var n,p;var j=[];if(l=="enrol"){n=i("#local_eduvidual_courses_orgusers");p=i("#local_eduvidual_courses_setrole").val()}else{if(l=="unenrol"){n=i("#local_eduvidual_courses_courseusers");p="remove"}}if(typeof n==="undefined"){return}var o=+i("#local_eduvidual_courses").attr("data-orgid");var m=+i("#local_eduvidual_courses").attr("data-courseid");var j=[];i(n).find('option:selected:not([value=""])').each(function(){j.push(+i(this).val())});require(["local_eduvidual/main"],function(q){q.connect({module:"teacher",act:"user_set",orgid:o,courseid:m,role:p,userids:j},{signalItem:i(k)})})},}});