define(["jquery","core/ajax","core/modal_events","core/modal_factory","core/notification","core/str","core/url","block_eduvidual/main","block_eduvidual/user","block_eduvidual/widgets"],function(a,b,c,d,e,f,g,h,i,j){return{debug:0,customcsscache:"",addParentFilter:function(b,c){var d=a("#block_eduvidual_manage_addparent_studentfilter").attr("data-orgid"),e=0,f=a("#block_eduvidual_manage_addparent_"+b);a(f).empty(),"student"==b?(a("#block_eduvidual_manage_addparent_parentfilter").val(""),a("#block_eduvidual_manage_addparent_parent").empty()):e=a("#block_eduvidual_manage_addparent_student").val(),("student"!=b||a(c).val().length>3)&&require(["block_eduvidual/main"],function(g){g.connect({module:"manage",act:"addparent_filter",orgid:d,filter:a(c).val(),studentid:e},{signalItem:c,appendItem:f,type:b})})},addParentSelectStudent:function(){this.addParentFilter("parent",a("#block_eduvidual_manage_addparent_parentfilter"))},addParent:function(b){var c=a("#block_eduvidual_manage_addparent_studentfilter").attr("data-orgid"),d=a("#block_eduvidual_manage_addparent_student").val(),e=a("#block_eduvidual_manage_addparent_parent").val();d>0&&e>0&&require(["block_eduvidual/main"],function(a){a.connect({module:"manage",act:"addparent",orgid:c,studentid:d,parentid:e},{signalItem:b})})},addUser:function(b){"undefined"==typeof b&&(b=a("#block_eduvidual_manage_adduser").val());var c=a("#block_eduvidual_manage_adduser_role").val(),d=a("#block_eduvidual_manage_adduser").attr("data-orgid");require(["block_eduvidual/main"],function(e){e.connect({module:"manage",act:"adduser",orgid:d,role:c,secret:b},{signalItem:a("#block_eduvidual_manage_adduser")})})},addUserAnonymous:function(){var b=+a("#block_eduvidual_manage_createuseranonymous_orgid").val(),c=a("#block_eduvidual_manage_createuseranonymous_role").val(),d=+a("#block_eduvidual_manage_createuseranonymous_amount").val(),g=a("#block_eduvidual_manage_createuseranonymous_bunch").val(),h=50;d>h?f.get_strings([{key:"manage:createuseranonymous:exceededmax:title",component:"block_eduvidual"},{key:"manage:createuseranonymous:exceededmax:text",component:"block_eduvidual",param:{maximum:h}}]).done(function(a){e.alert(a[0],a[1])}).fail(e.exception):require(["block_eduvidual/main"],function(e){e.connect({module:"manage",act:"adduser_anonymous",orgid:b,role:c,amount:d,bunch:g},{signalItem:a("#block_eduvidual_manage_adduseranonymous_btn")})})},categoryAdd:function(b,c,d){if("undefined"!=typeof b)for(var g=a(b);!a(g).is("li");)g=a(g).parent();"undefined"==typeof c&&(c=+a(".ul-eduvidual-courses").attr("data-orgid")),"undefined"==typeof d&&(d=+g.attr("data-categoryid"));var h={orgid:c,li:g,parentid:d,run:function(a){var b=this;null!==a&&a.length>2?require(["block_eduvidual/main"],function(c){c.connect({module:"manage",act:"addcategory",orgid:b.orgid,parentid:b.parentid,name:a},{parent:b.li})}):null!==a&&f.get_strings([{key:"categoryadd:title:length:title",component:"block_eduvidual"},{key:"categoryadd:title:length:text",component:"block_eduvidual"}]).done(function(a){e.alert(a[0],a[1])}).fail(e.exception)}};console.log(h);var i=j.prompt();f.get_strings([{key:"categoryadd:title",component:"block_eduvidual"},{key:"categoryadd:text",component:"block_eduvidual"}]).done(function(a){i.create(a[0],a[1],"",h)}).fail(e.exception)},categoryEdit:function(b,c,d,g){if("undefined"!=typeof b)for(var h=a(b);!a(h).is("li");)h=a(h).parent();"undefined"==typeof c&&(c=+a(".ul-eduvidual-courses").attr("data-orgid")),"undefined"==typeof d&&(d=+h.attr("data-categoryid")),"undefined"==typeof g&&(g="");var i={orgid:c,li:h,parentid:d,run:function(a){var b=this;null!==a&&a.length>2?require(["block_eduvidual/main"],function(c){c.connect({module:"manage",act:"editcategory",orgid:b.orgid,parentid:b.parentid,name:a},{parent:b.li})}):null!==a&&f.get_strings([{key:"categoryedit:title:length:title",component:"block_eduvidual"},{key:"categoryedit:title:length:text",component:"block_eduvidual"}]).done(function(a){e.alert(a[0],a[1])}).fail(e.exception)}};console.log(i);var k=j.prompt();f.get_strings([{key:"categoryadd:title",component:"block_eduvidual"},{key:"categoryadd:text",component:"block_eduvidual"}]).done(function(a){k.create(a[0],a[1],g,i)}).fail(e.exception)},categoryRemove:function(b,c,d,g){if("undefined"!=typeof c&&c){if("undefined"==typeof d&&(d=+a(".ul-eduvidual-courses").attr("data-orgid")),"undefined"==typeof g){for(var h=a(b);!a(h).is("li");)h=a(h).parent();g=+h.attr("data-categoryid")}require(["block_eduvidual/main"],function(a){a.connect({module:"manage",act:"removecategory",orgid:d,parentid:g},{parent:h})})}else{var i=this;f.get_strings([{key:"categoryremove:title",component:"block_eduvidual"},{key:"categoryremove:text",component:"block_eduvidual"},{key:"yes"},{key:"no"}]).done(function(a){e.confirm(a[0],a[1],a[2],a[3],function(){i.categoryRemove(b,!0,d,g)})}).fail(e.exception)}},createAccesscode:function(){var b=a("#block_eduvidual_manage_accesscode_code").val(),c=+a("#block_eduvidual_manage_adduser").attr("data-orgid"),d=a("#block_eduvidual_manage_accesscode_maturity").val(),e=a("#block_eduvidual_manage_accesscode_role").val();require(["block_eduvidual/main"],function(f){f.connect({module:"manage",act:"accesscode_create",orgid:c,code:b,role:e,maturity:d},{signalItem:a("#block_eduvidual_manage_accesscode_btn")})})},customcss:function(){var b=a("#block_eduvidual_manage_customcss").attr("data-orgid");require(["block_eduvidual/main"],function(c){c.watchValue({target:"#block_eduvidual_manage_customcss",orgid:b,run:function(){c.connect({module:"manage",act:"customcss",orgid:this.orgid,customcss:a(this.target).val()},{signalItem:a(this.target)})}})})},editProfile:function(g,i,j){f.get_strings([{key:"profile",component:"core"}]).done(function(f){var k="block_eduvidual_manager_user_form",l={orgid:g,userid:i};h.spinnerGrid(!0),b.call([{methodname:k,args:l,done:function(k){d.create({type:d.types.SAVE_CANCEL,title:f[0],body:k}).then(function(d){var f=d.getRoot();f.on(c.save,function(c){c.preventDefault();var h="block_eduvidual_manager_user_update",k={orgid:g,userid:i,firstname:a(f).find('[name="firstname"]').val(),lastname:a(f).find('[name="lastname"]').val(),email:a(f).find('[name="email"]').val()};b.call([{methodname:h,args:k,done:function(a){console.log("saved",a),"undefined"!=typeof a.success&&1==a.success&&(d.hide(),"undefined"!=typeof j&&"undefined"!=typeof j.run&&j.run()),"undefined"!=typeof a.message&&e.alert(a.subject,a.message)},fail:e.exception}])}),h.spinnerGrid(!1),d.show()})},fail:e.exception}])}).fail(e.exception)},exportUserPopup:function(g,h){this.debug>0&&console.log("block_eduvidual/manager:exportUserPopup(orgid, userids)",g,h),b.call([{methodname:"block_eduvidual_manager_user_exportform",args:{orgid:g,userids:h},done:function(b){d.create({title:f.get_string("export","block_eduvidual"),type:d.types.SAVE_CANCEL,body:b}).done(function(b){var d=b.getRoot();d.on(c.save,function(c){c.preventDefault(),b.hide(),a(d).find("form").submit(),a(d).remove()}),f.get_strings([{key:"export",component:"block_eduvidual"}]).done(function(b){a(d).find('.modal-footer button[data-action="save"]').html(b[0])}),a(d).find('button[type="submit"]').remove(),b.show()})},fail:e.exception}])},forceEnrol:function(a){require(["block_eduvidual/main"],function(b){b.connect({module:"manage",act:"force_enrol",courseid:a},{})})},maildomain:function(b,c,d){this.debug>0&&console.log("MANAGER.maildomain(inp, orgid, type)",b,c,d),require(["block_eduvidual/main"],function(e){e.watchValue({orgid:c,target:a(b),type:d,run:function(){var b=this;require(["block_eduvidual/main"],function(c){c.connect({module:"manage",act:"maildomain",orgid:b.orgid,type:b.type,maildomain:a(b.target).val()},{signalItem:a(b.target)})})}})})},setpwreset:function(){var b=a("#block_eduvidual_manage_adduser").attr("data-orgid"),c=(a("#block_eduvidual_manage_setuserrole_role").val(),[]);a('#block_eduvidual_manage_setuserrole_user option:selected:not([value=""])').each(function(){c.push(a(this).val())}),0!=c.length&&require(["block_eduvidual/main"],function(d){d.connect({module:"manage",act:"setpwreset",orgid:b,secrets:c},{signalItem:a("#block_eduvidual_manage_setuserrole")})})},setuserrole:function(){var b=a("#block_eduvidual_manage_adduser").attr("data-orgid"),c=a("#block_eduvidual_manage_setuserrole_role").val(),d=[];a('#block_eduvidual_manage_setuserrole_user option:selected:not([value=""])').each(function(){d.push(a(this).val())}),0!=d.length&&require(["block_eduvidual/main"],function(e){e.connect({module:"manage",act:"setuserrole",orgid:b,role:c,secrets:d},{signalItem:a("#block_eduvidual_manage_setuserrole")})})},setuserrole_search:function(b,c){var d=a("#block_eduvidual_manage_adduser").attr("data-orgid"),e=a("#block_eduvidual_manage_setuserrole_search").val();e.length<2||require(["block_eduvidual/main"],function(a){a.connect({module:"manage",act:"setuserrole_search",orgid:d,search:e},{marksuccess:b,markfailed:c})})},result:function(b){if("accesscode_create"==b.data.act&&"ok"==b.result.status&&(top.location.href=top.location.href),"accesscode_revoke"==b.data.act&&"ok"==b.result.status&&(top.location.href=top.location.href),"addcategory"==b.data.act&&(require(["block_eduvidual/main"],function(a){a.confirmed('.ul-eduvidual-courses li[data-categoryid="'+b.data.parentid+'"]',"ok"==b.result.status)}),"ok"==b.result.status&&("undefined"==typeof b.payload.parent?require(["block_eduvidual/user"],function(a){a.loadCategory(b.data.parentid,b.data.orgid)}):top.location.href=top.location.href)),"addparent"==b.data.act&&this.addParentSelectStudent(),"addparent_filter"==b.data.act){a(b.payload.appendItem).empty();var c=Object.keys(b.result.users);if(c.length>0)for(var d=0;d<c.length;d++){var h=b.result.users[c[d]],i="";"parent"==b.payload.type&&(i="undefined"!=typeof h.isparent&&h.isparent?"+ ":"- "),a(b.payload.appendItem).append(a("<option>").html(i+h.userfullname+" ("+h.email+")").attr("value",h.id))}}if("adduser"!=b.data.act&&"setuserrole"!=b.data.act||("ok"==b.result.status&&(a("#block_eduvidual_manage_"+b.data.act).val("ok"),setTimeout(function(){a("#block_eduvidual_manage_"+b.data.act).val("")},500)),this.setuserrole_search()),"adduser_anonymous"==b.data.act&&(a("#block_eduvidual_manage_createuseranonymous_success span").html(b.result.success),a("#block_eduvidual_manage_createuseranonymous_failed span").html(b.result.failed),a("#block_eduvidual_manage_createuseranonymous_success").css("display",b.result.success>0?"block":"none"),a("#block_eduvidual_manage_createuseranonymous_failed").css("display",b.result.failed>0?"block":"none"),a("#block_eduvidual_manage_createuseranonymous_success input").attr("data-bunch",b.data.bunch)),"customcss"==b.data.act&&a("#block_eduvidual_style_org").html(b.data.customcss),"force_enrol"==b.data.act&&"ok"==b.result.status&&(top.location.href=g.fileUrl("/course/view.php","")+"?id="+b.data.courseid),"removecategory"!=b.data.act&&"editcategory"!=b.data.act||(require(["block_eduvidual/main"],function(a){a.confirmed('.ul-eduvidual-courses li[data-categoryid="'+b.data.parentid+'"]',"ok"==b.result.status)}),"ok"==b.result.status&&("undefined"==typeof b.payload.parent?require(["block_eduvidual/user"],function(a){a.loadCategory("undefined"!=typeof b.result.removedcat?b.result.removedcat.parent:b.result.editedcat.id,b.data.orgid)}):"removecategory"==b.data.act?setTimeout(function(){a('.ul-eduvidual-courses li[data-categoryid="'+b.data.parentid+'"]').remove()},500):"editcategory"==b.data.act&&a('.ul-eduvidual-courses li[data-categoryid="'+b.data.parentid+'"]>label>span').html(b.data.name))),console.log(b),"setpwreset"==b.data.act&&f.get_strings([{key:"manage:users:setpwreset",component:"block_eduvidual"}]).done(function(a){require(["core/modal_factory","core/templates"],function(c,d){c.create({title:a[0],body:d.render("block_eduvidual/manage_setpwreset_modal",{failed:b.result.failed.join(", "),hasfailed:b.result.failed.length,hasupdated:b.result.updated.length,updated:b.result.updated.join(", ")}),footer:""}).done(function(a){a.show()})})}).fail(e.exception),"setuserrole_search"==b.data.act&&"undefined"!=typeof b.result.users){a('#block_eduvidual_manage_setuserrole_user option:not([value=""])').remove();for(var d=0;d<b.result.users.length;d++){var j=a("<option>").attr("value",b.result.users[d].secret).html(b.result.users[d].userfullname+(""!=b.result.users[d].email?" ("+b.result.users[d].email+")":""));a("#block_eduvidual_manage_setuserrole_user").append(j)}var k=b.payload.marksuccess;"undefined"!=typeof k&&k.length>0&&require(["block_eduvidual/main"],function(b){for(var c=0;c<k.length;c++)b.signal({signalItem:a('#block_eduvidual_manage_setuserrole_user option[value="'+k[c]+'"]')},void 0,"success")});var l=b.payload.markfailed;if("undefined"!=typeof l&&l.length>0)for(var d=0;d<l.length;d++)require(["block_eduvidual/main"],function(b){b.signal({signalItem:a('#block_eduvidual_manage_setuserrole_user option[value="'+l[d]+'"]')},void 0,"success")})}},revokeAccesscode:function(b){var c=+a("#block_eduvidual_manage_adduser").attr("data-orgid");require(["block_eduvidual/main"],function(a){a.connect({module:"manage",act:"accesscode_revoke",orgid:c,id:b},{})})}}});