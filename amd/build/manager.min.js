define(["jquery","core/ajax","core/modal_events","core/modal_factory","core/notification","core/str","core/url","local_eduvidual/main","local_eduvidual/user","local_eduvidual/widgets"],function(e,h,j,i,f,b,g,c,d,a){return{addParentFilterRequest:0,debug:0,customcsscache:"",addParentFilter:function(m,n){console.log("local_eduvidual/main:addParentFilter(type, inp)",m,n);this.addParentFilterRequest++;var p=e("#local_eduvidual_manage_addparent_studentfilter").attr("data-orgid");var o=0;var l=e("#local_eduvidual_manage_addparent_"+m);e(l).empty();if(e(n).val().length==0){e(n).val("*")}o=e("#local_eduvidual_manage_addparent_student").val();var k=this.addParentFilterRequest;require(["local_eduvidual/main"],function(q){q.connect({module:"manage",act:"addparent_filter",orgid:p,filter:e(n).val(),studentid:o},{signalItem:n,appendItem:l,type:m,request:k})})},addParentSelectStudent:function(){this.addParentFilter("parent",e("#local_eduvidual_manage_addparent_parentfilter"))},addParent:function(k){var n=e("#local_eduvidual_manage_addparent_studentfilter").attr("data-orgid");var m=e("#local_eduvidual_manage_addparent_student").val();var l=e("#local_eduvidual_manage_addparent_parent").val();if(m>0&&l>0){require(["local_eduvidual/main"],function(o){o.connect({module:"manage",act:"addparent",orgid:n,studentid:m,parentid:l},{signalItem:k})})}},addUser:function(k){if(typeof k==="undefined"){k=e("#local_eduvidual_manage_adduser").val()}var m=e("#local_eduvidual_manage_adduser_role").val();var l=e("#local_eduvidual_manage_adduser").attr("data-orgid");require(["local_eduvidual/main"],function(n){n.connect({module:"manage",act:"adduser",orgid:l,role:m,secret:k},{signalItem:e("#local_eduvidual_manage_adduser")})})},addUserAnonymous:function(){var o=+e("#local_eduvidual_manage_createuseranonymous_orgid").val();var n=e("#local_eduvidual_manage_createuseranonymous_role").val();var l=+e("#local_eduvidual_manage_createuseranonymous_amount").val();var k=e("#local_eduvidual_manage_createuseranonymous_cohorts").val();var m=50;if(l>m){b.get_strings([{key:"manage:createuseranonymous:exceededmax:title",component:"local_eduvidual"},{key:"manage:createuseranonymous:exceededmax:text",component:"local_eduvidual",param:{maximum:m}},]).done(function(p){f.alert(p[0],p[1])}).fail(f.exception)}else{require(["local_eduvidual/main"],function(p){p.connect({module:"manage",act:"adduser_anonymous",orgid:o,role:n,amount:l,cohorts:k},{signalItem:e("#local_eduvidual_manage_adduseranonymous_btn")})})}},categoryAdd:function(o,p,n){if(typeof o!=="undefined"){var l=e(o);while(!e(l).is("li")){l=e(l).parent()}}if(typeof p==="undefined"){p=+e(".ul-eduvidual-courses").attr("data-orgid")}if(typeof n==="undefined"){n=+l.attr("data-categoryid")}var m={orgid:p,li:l,parentid:n,run:function(q){var r=this;if(q!==null&&q.length>2){require(["local_eduvidual/main"],function(s){s.connect({module:"manage",act:"addcategory",orgid:r.orgid,parentid:r.parentid,name:q},{parent:r.li})})}else{if(q!==null){b.get_strings([{key:"categoryadd:title:length:title",component:"local_eduvidual"},{key:"categoryadd:title:length:text",component:"local_eduvidual"},]).done(function(t){f.alert(t[0],t[1])}).fail(f.exception)}}},};console.log(m);var k=a.prompt();b.get_strings([{key:"categoryadd:title",component:"local_eduvidual"},{key:"categoryadd:text",component:"local_eduvidual"},]).done(function(q){k.create(q[0],q[1],"",m)}).fail(f.exception)},categoryEdit:function(p,q,o,m){if(typeof p!=="undefined"){var l=e(p);while(!e(l).is("li")){l=e(l).parent()}}if(typeof q==="undefined"){q=+e(".ul-eduvidual-courses").attr("data-orgid")}if(typeof o==="undefined"){o=+l.attr("data-categoryid")}if(typeof m==="undefined"){m=""}var n={orgid:q,li:l,parentid:o,run:function(r){var s=this;if(r!==null&&r.length>2){require(["local_eduvidual/main"],function(t){t.connect({module:"manage",act:"editcategory",orgid:s.orgid,parentid:s.parentid,name:r},{parent:s.li})})}else{if(r!==null){b.get_strings([{key:"categoryedit:title:length:title",component:"local_eduvidual"},{key:"categoryedit:title:length:text",component:"local_eduvidual"},]).done(function(t){f.alert(t[0],t[1])}).fail(f.exception)}}},};console.log(n);var k=a.prompt();b.get_strings([{key:"categoryadd:title",component:"local_eduvidual"},{key:"categoryadd:text",component:"local_eduvidual"},]).done(function(r){k.create(r[0],r[1],m,n)}).fail(f.exception)},categoryRemove:function(n,l,p,m){if(typeof l==="undefined"||!l){var o=this;b.get_strings([{key:"categoryremove:title",component:"local_eduvidual"},{key:"categoryremove:text",component:"local_eduvidual"},{key:"yes"},{key:"no"}]).done(function(q){f.confirm(q[0],q[1],q[2],q[3],function(){o.categoryRemove(n,true,p,m)})}).fail(f.exception)}else{if(typeof p==="undefined"){p=+e(".ul-eduvidual-courses").attr("data-orgid")}if(typeof m==="undefined"){var k=e(n);while(!e(k).is("li")){k=e(k).parent()}m=+k.attr("data-categoryid")}require(["local_eduvidual/main"],function(q){q.connect({module:"manage",act:"removecategory",orgid:p,parentid:m},{parent:k})})}},createAccesscode:function(){var l=e("#local_eduvidual_manage_accesscode_code").val();var n=+e("#local_eduvidual_manage_adduser").attr("data-orgid");var k=e("#local_eduvidual_manage_accesscode_maturity").val();var m=e("#local_eduvidual_manage_accesscode_role").val();require(["local_eduvidual/main"],function(o){o.connect({module:"manage",act:"accesscode_create",orgid:n,code:l,role:m,maturity:k},{signalItem:e("#local_eduvidual_manage_accesscode_btn")})})},customcss:function(){var k=e("#local_eduvidual_manage_customcss").attr("data-orgid");require(["local_eduvidual/main"],function(l){l.watchValue({target:"#local_eduvidual_manage_customcss",orgid:k,run:function(){l.connect({module:"manage",act:"customcss",orgid:this.orgid,customcss:e(this.target).val()},{signalItem:e(this.target)})}})})},editProfile:function(m,k,l){b.get_strings([{key:"profile",component:"core"},]).done(function(n){var p="local_eduvidual_manager_user_form";var o={orgid:m,userid:k};h.call([{methodname:p,args:o,done:function(q){i.create({type:i.types.SAVE_CANCEL,title:n[0],body:q,}).then(function(s){var r=s.getRoot();r.on(j.save,function(u){u.preventDefault();var v="local_eduvidual_manager_user_update";var t={orgid:m,userid:k,firstname:e(r).find('[name="firstname"]').val(),lastname:e(r).find('[name="lastname"]').val(),email:e(r).find('[name="email"]').val(),};h.call([{methodname:v,args:t,done:function(w){console.log("saved",w);if(typeof w.success!=="undefined"&&w.success==1){s.hide();if(typeof l!=="undefined"&&typeof l.run!=="undefined"){l.run()}}if(typeof w.message!=="undefined"){f.alert(w.subject,w.message)}},fail:f.exception}])});s.show()})},fail:f.exception}])}).fail(f.exception)},exportUserPopup:function(l,k){if(this.debug>0){console.log("local_eduvidual/manager:exportUserPopup(orgid, userids)",l,k)}h.call([{methodname:"local_eduvidual_manager_user_exportform",args:{orgid:l,userids:k},done:function(m){i.create({title:b.get_string("export","local_eduvidual"),type:i.types.SAVE_CANCEL,body:m,}).done(function(o){var n=o.getRoot();n.on(j.save,function(p){p.preventDefault();o.hide();e(n).find("form").submit();e(n).remove()});b.get_strings([{key:"export",component:"local_eduvidual"},]).done(function(p){e(n).find('.modal-footer button[data-action="save"]').html(p[0])});e(n).find('button[type="submit"]').remove();o.show()})},fail:f.exception}])},forceEnrol:function(k){require(["local_eduvidual/main"],function(l){l.connect({module:"manage",act:"force_enrol",courseid:k},{})})},maildomain:function(l,m,k){if(this.debug>0){console.log("MANAGER.maildomain(inp, orgid, type)",l,m,k)}require(["local_eduvidual/main"],function(n){n.watchValue({orgid:m,target:e(l),type:k,run:function(){var p=this;require(["local_eduvidual/main"],function(o){o.connect({module:"manage",act:"maildomain",orgid:p.orgid,type:p.type,maildomain:e(p.target).val()},{signalItem:e(p.target)})})}})})},maildomain_apply:function(l,k){if(this.debug>0){console.log("MANAGER.maildomain_apply(orgid, btn)",l,k)}require(["local_eduvidual/main"],function(m){m.connect({module:"manage",act:"maildomain_apply",orgid:l},{signalItem:e(k)})})},overrideBBB:function(n,k){var o=e("#orgid-"+n).val();var m=e(".bbb_serverurl-"+n).val();var l=e(".bbb_sharedsecret-"+n).val();require(["local_eduvidual/main"],function(p){p.connect({module:"manage",act:"override_bigbluebutton",orgid:o,bbb_serverurl:m,bbb_sharedsecret:l},{signalItem:e(k)})})},overrideRolenames:function(m,l){var n=e("#orgid-"+m).val();var k=[];e(".overriderole-"+m).each(function(){k[k.length]={roleid:e(this).attr("data-roleid"),override:e(this).val()}});require(["local_eduvidual/main"],function(o){o.connect({module:"manage",act:"override_rolenames",orgid:n,roles:JSON.stringify(k)},{signalItem:e(l)})})},setpwreset:function(){var m=e("#local_eduvidual_manage_adduser").attr("data-orgid");var l=e("#local_eduvidual_manage_setuserrole_role").val();var k=[];e('#local_eduvidual_manage_setuserrole_user option:selected:not([value=""])').each(function(){k.push(e(this).val())});if(k.length==0){return}require(["local_eduvidual/main"],function(n){n.connect({module:"manage",act:"setpwreset",orgid:m,secrets:k},{signalItem:e("#local_eduvidual_manage_setuserrole")})})},setuserrole:function(){var m=e("#local_eduvidual_manage_adduser").attr("data-orgid");var l=e("#local_eduvidual_manage_setuserrole_role").val();var k=[];e('#local_eduvidual_manage_setuserrole_user option:selected:not([value=""])').each(function(){k.push(e(this).val())});if(k.length==0){return}require(["local_eduvidual/main"],function(n){n.connect({module:"manage",act:"setuserrole",orgid:m,role:l,secrets:k},{signalItem:e("#local_eduvidual_manage_setuserrole")})})},setuserrole_search:function(k,m){var n=e("#local_eduvidual_manage_adduser").attr("data-orgid");var l=e("#local_eduvidual_manage_setuserrole_search").val();if(l.length<2){return}else{require(["local_eduvidual/main"],function(o){o.connect({module:"manage",act:"setuserrole_search",orgid:n,search:l},{marksuccess:k,markfailed:m})})}},result:function(t){if(t.data.act=="accesscode_create"){if(t.result.status=="ok"){top.location.href=g.relativeUrl("/local/eduvidual/pages/manage.php",{orgid:t.data.orgid,act:"users",tab:"accesscodes"})}}if(t.data.act=="accesscode_revoke"){if(t.result.status=="ok"){top.location.href=g.relativeUrl("/local/eduvidual/pages/manage.php",{orgid:t.data.orgid,act:"users",tab:"accesscodes"})}}if(t.data.act=="addcategory"){require(["local_eduvidual/main"],function(o){o.confirmed('.ul-eduvidual-courses li[data-categoryid="'+t.data.parentid+'"]',(t.result.status=="ok"))});if(t.result.status=="ok"){if(typeof t.payload.parent==="undefined"){require(["local_eduvidual/user"],function(o){o.loadCategory(t.data.parentid,t.data.orgid)})}else{top.location.href=top.location.href}}}if(t.data.act=="addparent"){this.addParentSelectStudent()}if(t.data.act=="addparent_filter"){if(t.payload.request!=this.addParentFilterRequest){return}e(t.payload.appendItem).empty();var q=Object.keys(t.result.users);if(q.length>0){for(var m=0;m<q.length;m++){var n=t.result.users[q[m]];var r="";if(t.payload.type=="parent"){if(typeof n.isparent!=="undefined"&&n.isparent){r="+ "}else{r="- "}}e(t.payload.appendItem).append(e("<option>").html(r+n.userfullname+" ("+n.email+")").attr("value",n.id))}}}if(t.data.act=="adduser"||t.data.act=="setuserrole"){if(t.result.status=="ok"){e("#local_eduvidual_manage_"+t.data.act).val("ok");setTimeout(function(){e("#local_eduvidual_manage_"+t.data.act).val("")},500)}this.setuserrole_search()}if(t.data.act=="adduser_anonymous"){e("#local_eduvidual_manage_createuseranonymous_success span").html(t.result.success);e("#local_eduvidual_manage_createuseranonymous_failed span").html(t.result.failed);e("#local_eduvidual_manage_createuseranonymous_success").css("display",(t.result.success>0)?"block":"none");e("#local_eduvidual_manage_createuseranonymous_failed").css("display",(t.result.failed>0)?"block":"none");e("#local_eduvidual_manage_createuseranonymous_success input").attr("data-bunch",t.data.bunch)}if(t.data.act=="customcss"){e("#local_eduvidual_style_org").html(t.data.customcss)}if(t.data.act=="force_enrol"){if(t.result.status=="ok"){top.location.href=g.fileUrl("/course/view.php","")+"?id="+t.data.courseid}}if(t.data.act=="maildomain_apply"){if(typeof t.result.updated!=="undefined"){alert("Updated "+t.result.updated.Teacher+" Teachers and "+t.result.updated.Student+" Students")}}if(t.data.act=="removecategory"||t.data.act=="editcategory"){require(["local_eduvidual/main"],function(o){o.confirmed('.ul-eduvidual-courses li[data-categoryid="'+t.data.parentid+'"]',(t.result.status=="ok"))});if(t.result.status=="ok"){if(typeof t.payload.parent==="undefined"){require(["local_eduvidual/user"],function(o){o.loadCategory((typeof t.result.removedcat!=="undefined")?t.result.removedcat.parent:t.result.editedcat.id,t.data.orgid)})}else{if(t.data.act=="removecategory"){setTimeout(function(){e('.ul-eduvidual-courses li[data-categoryid="'+t.data.parentid+'"]').remove()},500)}else{if(t.data.act=="editcategory"){e('.ul-eduvidual-courses li[data-categoryid="'+t.data.parentid+'"]>label>span').html(t.data.name)}}}}}console.log(t);if(t.data.act=="setpwreset"){b.get_strings([{key:"manage:users:setpwreset",component:"local_eduvidual"},]).done(function(o){require(["core/modal_factory","core/templates"],function(s,u){s.create({title:o[0],body:u.render("local_eduvidual/manage_setpwreset_modal",{failed:t.result.failed.join(", "),hasfailed:t.result.failed.length,hasupdated:t.result.updated.length,updated:t.result.updated.join(", ")}),footer:"",}).done(function(v){v.show()})})}).fail(f.exception)}if(t.data.act=="setuserrole_search"){if(typeof t.result.users!=="undefined"){e('#local_eduvidual_manage_setuserrole_user option:not([value=""])').remove();for(var m=0;m<t.result.users.length;m++){var p=e("<option>").attr("value",t.result.users[m].secret).html(t.result.users[m].userfullname+((t.result.users[m].email!="")?" ("+t.result.users[m].email+")":""));e("#local_eduvidual_manage_setuserrole_user").append(p)}var l=t.payload.marksuccess;if(typeof l!=="undefined"&&l.length>0){require(["local_eduvidual/main"],function(s){for(var o=0;o<l.length;o++){s.signal({signalItem:e('#local_eduvidual_manage_setuserrole_user option[value="'+l[o]+'"]')},undefined,"success")}})}var k=t.payload.markfailed;if(typeof k!=="undefined"&&k.length>0){for(var m=0;m<k.length;m++){require(["local_eduvidual/main"],function(o){o.signal({signalItem:e('#local_eduvidual_manage_setuserrole_user option[value="'+k[m]+'"]')},undefined,"success")})}}}}},revokeAccesscode:function(l){var k=+e("#local_eduvidual_manage_adduser").attr("data-orgid");require(["local_eduvidual/main"],function(m){m.connect({module:"manage",act:"accesscode_revoke",orgid:k,id:l},{})})},}});