define(["jquery","core/ajax","core/notification","core/str","core/url","local_eduvidual/main"],function(f,b,c,e,a,d){return{debug:1,debug_gps:1,cache_orgs:{},refresh_identifier:0,varcache:undefined,blockfooter:function(g){if(this.debug>0){console.log("ADMIN.blockfooter()")}require(["local_eduvidual/main"],function(h){h.watchValue({target:"#local_eduvidual_admin_blockfooter",run:function(){var i=this;require(["local_eduvidual/main"],function(j){j.connect({module:"admin",act:"blockfooter",blockfooter:f(i.target).val()},{signalItem:f(i.target)})})}})})},coursebasements:function(g){if(this.debug>0){console.log("ADMIN.coursebasements()")}var h={module:"admin",act:"coursebasements",courseempty:f("#local_eduvidual_admin_coursebasements_courseempty").val(),courserestore:f("#local_eduvidual_admin_coursebasements_courserestore").val(),coursetemplate:f("#local_eduvidual_admin_coursebasements_coursetemplate").val(),};require(["local_eduvidual/main"],function(i){i.connect(h,{signalItem:f(g)})})},defaultrole:function(g,h){if(this.debug>0){console.log("ADMIN.defaultrole(type, role)",g,h)}require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"defaultrole",type:g,role:h},{signalItem:f("#local_eduvidual_admin_defaultrole"+g)})})},dropZonePath:function(){if(this.debug>0){console.log("ADMIN.dropZonePath()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_dropzonepath",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"dropzonepath",dropzonepath:f(h.target).val()},{signalItem:f(h.target)})})}})})},ltiresourcekey:function(){if(this.debug>0){console.log("ADMIN.ltiresourcekey()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_ltiresourcekey",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"ltiresourcekey",ltiresourcekey:f(h.target).val()},{signalItem:f(h.target)})})}})})},manageorgs_open:function(k,m){var i=f("#"+k+"-form");f(i).find(".local_eduvidual_signal_error").removeClass("local_eduvidual_signal_error");var l=this.cache_orgs[m];if(typeof l!=="undefined"){var g=Object.keys(l);for(var h=0;h<g.length;h++){var j=g[h];f("#"+k+"-field-"+j).attr("data-orig",l[j]).val(l[j])}f("#"+k+"-field-manage").attr("data-orig",l.orgid)}else{i.find("input").val("").attr("data-orig","")}if(typeof l!=="undefined"&&typeof l.categoryid!=="undefined"&&l.categoryid>0){f("#"+k+"-field-orgid").attr("readonly","readonly");f("#"+k+"-field-categoryid").css("display","block");f("#"+k+"-field-manage").css("display","block")}else{f("#"+k+"-field-orgid").removeAttr("readonly");f("#"+k+"-field-categoryid").css("display","none");f("#"+k+"-field-manage").css("display","none")}},manageorgs_reset:function(g){this.manageorgs_open(g,0)},manageorgs_search:function(g){require(["local_eduvidual/main"],function(h){h.watchValue({target:"#"+g+"-search",run:function(){var i=this;require(["local_eduvidual/main"],function(j){j.connect({module:"admin",act:"manageorgs_search",search:f(i.target).val()},{signalItem:f(i.target),uniqid:g})})}})})},manageorgs_store:function(i){var h=f("#"+i+"-form");f(h).find(".local_eduvidual_signal_error").removeClass("local_eduvidual_signal_error");var g={};h.find("input").each(function(){if(typeof f(this).attr("id")!=="undefined"&&f(this).attr("id")!=""){var j=f(this).attr("id").replace(i+"-field-","");g[j]=f(this).val()}});require(["local_eduvidual/main"],function(j){j.connect({module:"admin",act:"manageorgs_store",fields:g},{signalItem:f("#"+i+"-store"),uniqid:i})})},navbar:function(){if(this.debug>0){console.log("ADMIN.navbar()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_navbar",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"navbar",navbar:f(h.target).val()},{signalItem:f(h.target)})})}})})},orgrole:function(g,h){if(this.debug>0){console.log("ADMIN.orgrole(type, role)",g,h)}require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"orgrole",type:g,role:h},{signalItem:f("#local_eduvidual_admin_orgrole"+g)})})},globalrole:function(g,h){if(this.debug>0){console.log("ADMIN.globalrole(type, role)",g,h)}require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"globalrole",type:g,role:h},{signalItem:f("#local_eduvidual_admin_globalrole"+g)})})},modifylogin:function(g){if(this.debug>0){console.log("ADMIN.modifylogin(setto)",g)}require(["local_eduvidual/main"],function(h){h.connect({module:"admin",act:"modifylogin",setto:g},{signalItem:f("#local_eduvidual_admin_modifylogin")})})},moduleCatForm:function(g){require(["local_eduvidual/main"],function(h){h.connect({module:"admin",act:"modulecatform",categoryid:g})})},moolevels:function(g){if(this.debug>0){console.log("ADMIN.moolevels()")}var h=new Array();f.each(f("input[name='moolevels[]']:checked"),function(){h.push(f(this).val())});require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"moolevels",moolevels:h},{signalItem:f(g).parent()})})},org_gps:function(n,l,k,j,h){var m=this;m.refresh_identifier++;var p=m.refresh_identifier;if(typeof n==="undefined"){n=f(".local_eduvidual_admin_map").attr("id")}if(typeof l==="undefined"){l=-200}if(typeof k==="undefined"){k=200}if(typeof j==="undefined"){j=-200}if(typeof h==="undefined"){h=200}console.log("ADMIN.org_gps(uniqid, lon1, lon2, lat1, lat2)",n,l,k,j,h);var o=f("#"+n+"-include-nonegroup").prop("checked")?1:0;var g="local_eduvidual_admin_org_gps";var i={lon1:l,lon2:k,lat1:j,lat2:h,includenonegroup:o,advanceddata:0};if(typeof m.map!=="undefined"){m.map.remove()}if(m.debug_gps){console.log("Sending to "+g,i)}b.call([{methodname:g,args:i,done:function(q){if(m.refresh_identifier!=p){return}try{q=JSON.parse(q)}catch(r){}if(m.debug_gps){console.log("Got response",q)}m.orgs=q;m.org_gps_list(n)},fail:c.exception}])},org_gps_bounds:function(j){var g=this;if(typeof g.map==="undefined"){return}var h=g.map.getBounds().toBBoxString().split(",");if(g.debug_gps){console.log("Setting bounds to",h)}f("#"+j).attr("data-lon1",h[0]);f("#"+j).attr("data-lon2",h[2]);f("#"+j).attr("data-lat1",h[1]);f("#"+j).attr("data-lat2",h[3]);if(typeof g.map_moved==="undefined"){g.map_moved=0}else{g.map_moved++;var i=g.map_moved;setTimeout(function(){if(i==g.map_moved){g.org_gps_refresh(j)}},1000)}},org_gps_list:function(g){var h=this;if(h.debug_gps){console.log("ADMIN.org_gps_list(uniqid)",g)}if(typeof h.map!=="undefined"){h.map.remove()}var r=h.refresh_identifier;var F=f("#"+g+"-include-nonegroup").prop("checked")?1:0;f("#"+g+"-legend td.none").parent().css("display",F?"table-row":"none");f("#"+g+"-legend-none").css("display",F?"inline-block":"none");var j=h.orgs;var l=new Date(f("#"+g+"-year").val(),f("#"+g+"-month").val()-1,f("#"+g+"-day").val(),f("#"+g+"-hour").val(),f("#"+g+"-minute").val(),f("#"+g+"-second").val(),0);f("#"+g+"-second").val(l.getSeconds());f("#"+g+"-minute").val(l.getMinutes());f("#"+g+"-hour").val(l.getHours());f("#"+g+"-day").val(l.getDate());f("#"+g+"-month").val(l.getMonth()+1);f("#"+g+"-year").val(l.getFullYear());var C=Math.floor(l.getTime()/1000);var o=200;var k=200;var D=-200;var y=-200;var z={both:0,eduv:0,lpf:0,none:0,};var n=[L.layerGroup(),L.layerGroup(),L.layerGroup(),L.layerGroup(),];var p={0:"",1:"Burgenland",2:"Kärnten",3:"Niederösterreich",4:"Oberösterreich",5:"Salzburg",6:"Steiermark",7:"Tirol",8:"Vorarlberg",9:"Wien",};var i={0:"Sonstige",1:"VS",2:"MS",3:"Sonderschule",4:"PTS",5:"BS",6:"Gymnasium",7:"HTL",8:"HAK",9:"HUM",};Object.keys(j).forEach(function(I){console.log("refresh_identifier",h.refresh_identifier,r);if(h.refresh_identifier!=r){return}j[I].url=a.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+j[I].orgid);var G=j[I].orgid.toString().split("").pop();var J=j[I].orgid.toString().split("")[0];j[I].classes=i[G]+" "+p[J];var H="red";j[I].ignore=false;if(j[I].authenticated>0&&j[I].authenticated<C&&j[I].lpf!=null){H="orange";z.both++;j[I].classes+=" both";j[I].layer=2;j[I].url=a.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+j[I].orgid)}else{if(j[I].authenticated>0&&j[I].authenticated<C){H="green";z.eduv++;j[I].classes+=" eduv";j[I].layer=3;j[I].url=a.relativeUrl("/local/eduvidual/pages/myorgs.php?orgid="+j[I].orgid)}else{if(j[I].authenticated<C&&j[I].lpf!=null){H="blue";z.lpf++;j[I].classes+=" lpf";j[I].layer=1;j[I].url="https://www3.lernplattform.schule.at/"+j[I].lpf}else{if(F==1){H="lightgray";z.none++;j[I].classes+=" none invisible";j[I].layer=0;j[I].url=""}else{j[I].ignore=true}}}}if(H!="lightgray"&&G>0){if(j[I].lon<k){k=j[I].lon}if(j[I].lon>y){y=j[I].lon}if(j[I].lat<o){o=j[I].lat}if(j[I].lat>D){D=j[I].lat}}j[I].marker=a.relativeUrl("/local/eduvidual/pix/google-maps-pin-"+H+".svg#"+j[I].classes+"#"+j[I].layer)});o=45.18189988240382;k=8.88805461218309;D=49.517950306694665;y=17.45739054968309;var m=[[o,k],[D,y]];var w=(o+D)/2;var t=(k+y)/2;var A=[w,t];if(h.debug_gps){console.log("Bounds",m)}if(h.debug_gps){console.log("Center",A)}var v=f("#"+g+"-map").width();if(h.debug_gps){console.log("Width",v)}if(h.debug_gps){console.log("Height",v/4*3)}f("#"+g+"-map").css("height",v/4*3+"px");var x=L.icon({iconUrl:a.relativeUrl("/local/eduvidual/pix/google-maps-pin-blue.svg"),iconRetinaUrl:a.relativeUrl("/local/eduvidual/pix/google-maps-pin-blue.svg"),iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14]});Object.keys(j).forEach(function(I){if(h.refresh_identifier!=r){return}if(j[I].ignore){return}var G=x;if(typeof j[I].marker!=="undefined"&&j[I].marker!=""){G=L.icon({iconUrl:j[I].marker,iconRetinaUrl:j[I].marker,iconSize:[29,24],iconAnchor:[9,21],popupAnchor:[0,-14],})}var H=L.marker([j[I].lat,j[I].lon],{icon:G}).bindPopup((typeof j[I].url!=="undefined"&&j[I].url!="")?'<a href="'+j[I].url+'" target="_blank">'+j[I].name+" ("+I+")</a>":j[I].name);H.addTo(n[j[I].layer])});var s=[l.getFullYear(),String(l.getMonth()+1).padStart(2,"0"),String(l.getDate()).padStart(2,"0")].join("-");var q=1/9*6;var E="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";var u="Visualisierung der Moodle-Schulen in Österreich | "+s+' | <a href="https://www.lernmanagement.at" target="_blank">Zentrum für Lernmanagement</a> | powered by &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>';h.map=L.map(g+"-map",{boxZoom:true,center:A,layers:n,zoom:14,zoomControl:false,zoomSnap:0.5,});h.map.fitBounds(m,{maxZoom:18});h.map.on("moveend",function(G){h.org_gps_bounds(g)});h.map.on("resize",function(H){if(h.debug_gps){console.log("Map was resized",H)}var G=f("#"+g+"-map").width();if(h.debug_gps){console.log("Width",G)}if(h.debug_gps){console.log("Height",G*q)}f("#"+g+"-map").css("height",G*q+"px")});var B={normal:L.tileLayer(E,{attribution:u,id:"mapbox.normal",subdomains:["a","b","c"]})};B.normal.addTo(h.map);L.control.zoom({position:"bottomright"}).addTo(h.map);f("#"+g+" .leaflet-marker-pane img").each(function(H,I){if(h.refresh_identifier!=r){return}var J=f(I).attr("src");var G=J.split("#");if(G.length==3){f(I).addClass(G[1].replace(","," "));f(I).css("z-index",990+G[2])}});f("#"+g+"-map").css("height",f("#"+g+"-map").width()*q+"px");h.org_gps_bounds(g);h.org_gps_refresh(g)},org_gps_refresh:function(l){var g=this;g.refresh_identifier++;var h=g.refresh_identifier;console.log("ADMIN.org_gps_refresh(uniqid)",l);var k=f("#"+l+"-map");f("#"+l+"-map .leaflet-marker-icon").each(function(n,p){if(g.refresh_identifier!=h){return}var m=p.style.transform.split(/\w+\(|\);?/);if(m.length==3){var o=m[1].split("px").join("").split(" ").join("").split(",")}if(o.length==3){if(o[0]<0||o[0]>k.width()||o[1]<0||o[1]>k.height()){f(p).addClass("out-of-bounds")}else{f(p).removeClass("out-of-bounds")}}});f("#"+l+"-map .leaflet-marker-icon").addClass("flag-visible");f("#"+l+"-legend .trigger").each(function(m,p){if(g.refresh_identifier!=h){return}var o=f(p).attr("data-trigger-key");if(typeof o!=="undefined"&&o!==""){var n=f(p).prop("checked");if(!n){f("#"+l+"-map .leaflet-marker-icon."+o).removeClass("flag-visible")}}});f("#"+l+"-map .leaflet-marker-icon:not(.flag-visible)").addClass("invisible");f("#"+l+"-map .leaflet-marker-icon.flag-visible").removeClass("invisible");var j=f("#"+l+"-count-invisibles").prop("checked");var i={};f("#"+l+"-legend .trigger").each(function(p,s){if(g.refresh_identifier!=h){return}var r=f(s).attr("data-trigger-key");var m=f(s).attr("data-filterid");if(typeof r!=="undefined"&&r!==""){var q=f(s).prop("checked");var o=0;var n=f("#"+l+"-map .leaflet-marker-icon."+r+":not(.out-of-bounds)");if(j){o=n.length}else{if(q){o=n.not(".invisible").length}}f("#"+l+"-legend td."+r).html(o);if(typeof m!=="undefined"&&m!=""){if(typeof i[m]==="undefined"){i[m]=0}i[m]+=o}}});Object.keys(i).forEach(function(m){f("#"+l+"-legend table."+m+" td.sum").html(i[m])})},orgcoursebasement:function(g){if(this.debug>0){console.log("ADMIN.orgcoursebasement(basement)",g)}require(["local_eduvidual/main"],function(h){h.connect({module:"admin",act:"orgcoursebasement",basement:g},{signalItem:f("#local_eduvidual_admin_orgcoursebasement")})})},phpListConfig:function(h,g){if(this.debug>0){console.log("ADMIN.phpListConfig(field, el)",h,g)}require(["local_eduvidual/main"],function(i){i.watchValue({target:"#local_eduvidual_admin_phplist_"+h,run:function(){var j=this;require(["local_eduvidual/main"],function(k){k.connect({module:"admin",act:"phplistconfig",field:h,content:f(g).val()},{signalItem:f(j.target)})})}})})},protectedorgs:function(){if(this.debug>0){console.log("ADMIN.protectedorgs()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_protectedorgs",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"protectedorgs",protectedorgs:f(h.target).val()},{signalItem:f(h.target)})})}})})},questioncategories:function(j,g){if(this.debug>0){console.log("ADMIN.questioncategories(uniqid, catid)",j,g)}var h=f(".questioncategory-"+j+"-"+g);var i=new Array();var k=new Array();f.each(f(".questioncategories-"+j+":checked"),function(){var l=f(this).val();i.push(l);k.push(f(".supportcourses-"+j+"-"+l).val())});require(["local_eduvidual/main"],function(l){l.connect({module:"admin",act:"questioncategories",questioncategories:i,supportcourses:k},{signalItem:f(h)})})},registrationcc:function(){if(this.debug>0){console.log("ADMIN.registrationcc()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_registrationcc",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"registrationcc",registrationcc:f(h.target).val()},{signalItem:f(h.target)})})}})})},registrationsupport:function(){if(this.debug>0){console.log("ADMIN.registrationsupport()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_registrationsupport",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"registrationsupport",registrationsupport:f(h.target).val()},{signalItem:f(h.target)})})}})})},requireCapability:function(g){if(this.debug>0){console.log("ADMIN.requireCapability(val)",g)}require(["local_eduvidual/main"],function(h){h.connect({module:"admin",act:"requirecapability",requirecapability:g},{signalItem:f("#local_eduvidual_admin_requirecapability")})})},result:function(k){if(k.data.act=="blockfooter"){f("#local_eduvidual_footer").html(k.data.blockfooter)}if(k.data.act=="coursebasements"){history.go(0)}if(k.data.act=="manageorgs_search"){if(typeof k.result.status!=="undefined"&&k.result.status=="ok"){var i=f("#"+k.payload.uniqid+"-list").empty();this.cache_orgs=k.result.orgs;if(k.result.orgs.length===0){i.append(f("<li>").html("No results"))}else{var j=Object.keys(k.result.orgs);for(var g=0;g<j.length;g++){var l=k.result.orgs[j[g]];i.append(f("<li>").append(f("<a>").html(l.name+" ("+l.orgid+")").attr("href","#").attr("onclick","require(['local_eduvidual/admin'], function(ADMIN) { ADMIN.manageorgs_open('"+k.payload.uniqid+"', "+l.id+"); });")))}}}}if(k.data.act=="manageorgs_store"){if(typeof k.result.errors!=="undefined"&&k.result.errors.length>0){for(var g=0;g<k.result.errors.length;g++){var h=k.result.errors[g];f("#"+k.payload.uniqid+"-field-"+h).addClass("local_eduvidual_signal_error")}}}if(k.data.act=="modulecatstore"){require(["local_eduvidual/main"],function(n){n.confirmed("#local_eduvidual_admin_modulecat_form",(k.result.status=="ok"));var m=k.result.category;console.log("There is a category",m);if(k.result.status=="ok"&&typeof m.id!=="undefined"&&m.id>0){if(k.data.categoryid==-1){n.navigate(a.fileUrl("/local/eduvidual/pages/admin.php?act=modulecats&categoryid="+m.id,""));return}else{console.log("Category just updated");f('li[data-categoryid="'+m.id+'"]>a:first-child').html(m.name).removeClass("inactive").removeClass("active").addClass((m.active==1)?"active":"inactive");f("#local_eduvidual_admin_modulecat_form").attr("data-categoryid",m.id).attr("data-parentid",m.parentid).css("display","block");f('#local_eduvidual_admin_modulecat_form input[name="categoryid"]').val(m.id);f("#local_eduvidual_admin_modulecat_form_active").val(m.active);f("#local_eduvidual_admin_modulecat_form_name").val(m.name);f("#local_eduvidual_admin_modulecat_form_description").val(m.description);f("#local_eduvidual_admin_modulecat_form_imageurl").val(m.imageurl)}}f("#local_eduvidual_admin_modulecat_form_active").trigger("create")})}},statsSwitchColumn:function(j,g){console.log("ADMIN.statsSwitchColumn(uniqid, sender)",j,g);var i=f(g).attr("data-type");var h=f("."+j+"-"+i);var k=(f(g).prop("checked"))?"block":"none";h.css("display",k)},supportcourseurl:function(){if(this.debug>0){console.log("ADMIN.supportcourseurl()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_supportcourseurl",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"supportcourseurl",supportcourseurl:f(h.target).val()},{signalItem:f(h.target)})})}})})},trashcategory:function(){if(this.debug>0){console.log("ADMIN.trashcategory()")}require(["local_eduvidual/main"],function(g){g.watchValue({target:"#local_eduvidual_admin_trashcategory",run:function(){var h=this;require(["local_eduvidual/main"],function(i){i.connect({module:"admin",act:"trashcategory",trashcategory:f(h.target).val()},{signalItem:f(h.target)})})}})})},}});