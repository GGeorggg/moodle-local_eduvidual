define(["jquery","core/ajax","core/notification","core/str","core/url","block_eduvidual/main","block_eduvidual/manager","block_eduvidual/teacher","core/modal_factory","core/modal_events"],function(a,b,c,d,e,f,g,h,i,j){return{accesscode:function(){var b=+a("#block_eduvidual_user_accesscode_orgid").val(),c=a("#block_eduvidual_user_accesscode_code").val();require(["block_eduvidual/main"],function(d){d.connect({module:"user",act:"accesscode",orgid:b,code:c},{signalItem:a("#block_eduvidual_user_accesscode_btn")})})},actionCategories:function(b){var c=+a(".ul-eduvidual-courses").attr("data-categoryid"),d=+a(".ul-eduvidual-courses").attr("data-orgid");switch(a(b).val()){case"createcourse":h.loadCourseForm();break;case"createcategory":g.categoryAdd(void 0,d,c);break;case"editcategory":var e=a(".block_eduvidual_courses_title").html();g.categoryEdit(void 0,d,c,e);break;case"removecategory":g.categoryRemove(void 0,void 0,d,c)}a(b).val("")},defaultorg:function(b){require(["block_eduvidual/main"],function(c){c.connect({module:"user",act:"defaultorg",orgid:+b},{signalItem:a("#block_eduvidual_user_defaultorg")})})},loadCategory:function(b,c){"undefined"==typeof c&&(c=+a(".ul-eduvidual-courses").attr("data-orgid")),require(["block_eduvidual/main"],function(a){a.connect({module:"user",act:"categories",orgid:c,categoryid:b},{})})},triggerShowHidden:function(b){console.log("USER.triggerShowHidden(setto)",b),"undefined"==typeof b?a("#block_eduvidual_user_courselist").toggleClass("showhidden"):1==b?a("#block_eduvidual_user_courselist").addClass("showhidden"):a("#block_eduvidual_user_courselist").removeClass("showhidden")},placeSubmenu:function(){var b=0;a(".block_eduvidual_submenu_wrapper").each(function(){a(this).height()>0&&(b=a(this).height())}),console.log("USER.placeSubmenu(), h is ",b),a(".block_eduvidual_submenu_wrapper").css("margin-top",b/-2+"px")},setEditor:function(b){require(["block_eduvidual/main"],function(c){c.connect({module:"user",act:"seteditor",editor:a(b).val()},{signalItem:a(b)})})},setLandingPage:function(b){"undefined"==typeof b?d.get_strings([{key:"user:landingpage:title",component:"block_eduvidual"},{key:"user:landingpage:description",component:"block_eduvidual"},{key:"ok",component:"core"},{key:"cancel",component:"core"}]).done(function(a){c.confirm(a[0],a[1],a[2],a[3],function(){require(["block_eduvidual/user"],function(a){a.setLandingPage(top.location.href)})})}).fail(c.exception):require(["block_eduvidual/main"],function(c){c.connect({module:"user",act:"landingpage_set",url:b},{signalItem:a("#block_eduvidual_setlandingpage")})})},showModuleInfo:function(b){var e=a(b).children("h3").html(),f=a(b).children("p").html(),g=a(b).attr("data-url");console.log(g),"undefined"!=typeof g&&""!=g?d.get_strings([{key:"open",component:"block_eduvidual"},{key:"close",component:"block_eduvidual"}]).done(function(a){c.confirm(e,f,a[0],a[1],function(){require(["block_eduvidual/main"],function(a){a.navigate(g)})})}).fail(c.exception):c.alert(e,f)},toggleSubmenu:function(b){"undefined"!=typeof b?b?a(".block_eduvidual_submenu_wrapper").addClass("opened"):a(".block_eduvidual_submenu_wrapper").removeClass("opened"):a(".block_eduvidual_submenu_wrapper").toggleClass("opened")},setHidden:function(b){var c=a(b).parent(),d=+c.attr("data-courseid"),e=c.hasClass("inactive");require(["block_eduvidual/main"],function(a){a.connect({module:"user",act:"courselist_sethidden",courseid:d,setto:e?0:1},{li:c})})},result:function(b){if("accesscode"==b.data.act&&"ok"==b.result.status&&(top.location.href=e.fileUrl("/blocks/eduvidual/pages/categories.php","")+"?orgid="+b.result.orgid),"autologin"==b.data.act){var f=b.result.autologinurl+"/?userid="+b.result.userid+"&key="+b.result.key+"&urltogo="+encodeURI(b.payload.href);console.log("Navigating to ",f),window.open(f,"_blank")}if("categories"==b.data.act)if("ok"==b.result.status){var g=a(".ul-eduvidual-courses").empty();a(".block_eduvidual_courses_title").html(b.result.category.name),a(".ul-eduvidual-courses").attr("data-categoryid",b.data.categoryid);var h=a("<div>").addClass("grid-eq-2").css("text-align","center");if(g.append(h),d.get_strings([{key:"back",component:"block_eduvidual"},{key:"action",component:"block_eduvidual"},{key:"createcourse:here",component:"block_eduvidual"},{key:"createcategory:here",component:"block_eduvidual"},{key:"createcategory:rename",component:"block_eduvidual"},{key:"createcategory:remove",component:"block_eduvidual"}]).done(function(c){var d=a("<div>"),e=a("<a>").addClass("ui-btn btn btn-_secondary").attr("onclick","history.go(-1);").html(c[0]);"undefined"!=typeof b.result.parent&&b.result.parent.id>0&&e.attr("onclick",'require(["block_eduvidual/user"], function(USER) { USER.loadCategory('+b.result.parent.id+"); });").html(b.result.parent.name),e.html('<img src="/pix/t/left.svg" alt=""> '+e.html()),d.append(e),h.append(d);var f=a("<select>").attr("data-role","selectmenu").attr("onchange",'var sel = this; require(["block_eduvidual/user"], function(USER) { USER.actionCategories(sel); });');f.append(a('<option value="">'+c[1]+"</option>")),(["Administrator","Manager","Teacher"].indexOf(b.result.orgrole)>-1||"Administrator"==b.result.role)&&f.append(a('<option value="createcourse">'+c[2]+"</option>")),(["Administrator","Manager"].indexOf(b.result.orgrole)>-1||"Administrator"==b.result.role)&&(f.append(a('<option value="createcategory">'+c[3]+"</option>")),b.result.orgcategoryid!=b.data.categoryid&&(f.append(a('<option value="editcategory">'+c[4]+"</option>")),f.append(a('<option value="removecategory">'+c[5]+"</option>")))),f.children().length>1&&h.append(f)}).fail(c.exception),b.result.categories.length>0){for(var i=a("<ul>").attr("data-role","listview").attr("data-inset","true").attr("data-split-icon","plus").addClass("ui-listview ui-listview-inset ui-corner-all ui-shadow"),j=0;j<b.result.categories.length;j++){var k=b.result.categories[j],l=a("<li>");0==j&&l.addClass("ui-first-child");var m=a("<a>").attr("href","#").attr("onclick",'require(["block_eduvidual/user"], function(USER) { USER.loadCategory('+k.id+"); });").addClass("ui-btn btn");0==k.visible&&m.addClass("disabled").css("color","darkgray");var n=a("<img>").attr("src","/pix/i/withsubcat.svg").attr("alt","Course category").css("display","inline-block"),o=a("<h3>").html(k.name).css("line-height","2.5em").css("display","inline").css("margin-left","5px");l.append(m.append([n,o])),i.append(l)}g.append(i)}if(b.result.courses.length>0){for(var p=null!==localStorage.getItem("block_eduvidual_isembedded")&&1==localStorage.getItem("block_eduvidual_isembedded"),i=a("<ul>").attr("data-role","listview").attr("data-inset","true").addClass("ui-listview ui-listview-inset ui-corner-all ui-shadow"),j=0;j<b.result.courses.length;j++){var q=b.result.courses[j],l=a("<li>");0==q.visible&&l.addClass("block_eduvidual_inactive"),0==j&&l.addClass("ui-first-child");var f=e.fileUrl("/course/view.php","")+"?id="+q.id,r="";p&&(f="#",r='require(["block_eduvidual/jquery-ba-postmessage"], function(p) { p.post("open_course|'+q.id+'"); });');var n=a("<img>").attr("src",""!=q.image?q.image:"/pix/i/course.svg").attr("alt","Course"),m=a("<a>").attr("href",f).attr("onclick",r).attr("data-ajax","false").addClass("ui-btn btn"),o=a("<h3>").html(q.fullname).css("line-height","2.5em").css("display","inline").css("margin-left","5px");i.append(l.append(m.append([n,o])))}g.append(i)}}else g.append(a("<li>").html("ERROR"));"courselist_sethidden"==b.data.act&&(b.data.setto?a(b.payload.li).addClass("inactive ishidden"):a(b.payload.li).removeClass("inactive ishidden")),"whoami"!=b.data.act&&"login"!=b.data.act||("ok"==b.result.status?(b.payload.urltogo.indexOf("/pages/login_app.php")>0&&(console.log("This is the login page in app-mode - going to my courses"),b.payload.urltogo=e.fileUrl("/blocks/eduvidual/pages/courses.php","")),require(["block_eduvidual/main"],function(a){a.resume(b.payload.urltogo,b.result.userid)})):a("#block_eduvidual_overlay").remove())},showShibboleth:function(){var b=e.fileUrl("/auth/shibboleth_link","login.php?embed=1");console.log("popPage ",b),a.get(b).done(function(a){console.log("Got body ",a),i.create({title:"edu.IDAM",body:a}).done(function(a){console.log("Created modal"),a.show()})}).fail(function(a){console.err("Error",a)})}}});