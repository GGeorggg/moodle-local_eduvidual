define(["jquery","core/ajax","core/notification","core/str","core/url","block_eduvidual/main","block_eduvidual/manager","block_eduvidual/teacher","core/modal_factory","core/modal_events"],function(c,g,d,a,f,b,i,e,h,j){return{accesscode:function(){var l=+c("#block_eduvidual_user_accesscode_orgid").val();var k=c("#block_eduvidual_user_accesscode_code").val();require(["block_eduvidual/main"],function(m){m.connect({module:"user",act:"accesscode",orgid:l,code:k},{signalItem:c("#block_eduvidual_user_accesscode_btn")})})},actionCategories:function(l){var m=+c(".ul-eduvidual-courses").attr("data-categoryid");var n=+c(".ul-eduvidual-courses").attr("data-orgid");switch(c(l).val()){case"createcourse":e.loadCourseForm();break;case"createcategory":i.categoryAdd(undefined,n,m);break;case"editcategory":var k=c(".block_eduvidual_courses_title").html();i.categoryEdit(undefined,n,m,k);break;case"removecategory":i.categoryRemove(undefined,undefined,n,m);break}c(l).val("")},defaultorg:function(k){require(["block_eduvidual/main"],function(l){l.connect({module:"user",act:"defaultorg",orgid:+k},{signalItem:c("#block_eduvidual_user_defaultorg")})})},loadCategory:function(k,l){if(typeof l==="undefined"){l=+c(".ul-eduvidual-courses").attr("data-orgid")}require(["block_eduvidual/main"],function(m){m.connect({module:"user",act:"categories",orgid:l,categoryid:k},{})})},triggerShowHidden:function(k){console.log("USER.triggerShowHidden(setto)",k);if(typeof k==="undefined"){c("#block_eduvidual_user_courselist").toggleClass("showhidden")}else{if(k==1){c("#block_eduvidual_user_courselist").addClass("showhidden")}else{c("#block_eduvidual_user_courselist").removeClass("showhidden")}}},placeSubmenu:function(){var k=0;c(".block_eduvidual_submenu_wrapper").each(function(){if(c(this).height()>0){k=c(this).height()}});console.log("USER.placeSubmenu(), h is ",k);c(".block_eduvidual_submenu_wrapper").css("margin-top",(k/-2)+"px")},setEditor:function(k){require(["block_eduvidual/main"],function(l){l.connect({module:"user",act:"seteditor",editor:c(k).val()},{signalItem:c(k)})})},setLandingPage:function(k){if(typeof k==="undefined"){a.get_strings([{key:"user:landingpage:title",component:"block_eduvidual"},{key:"user:landingpage:description",component:"block_eduvidual"},{key:"ok",component:"core"},{key:"cancel",component:"core"},]).done(function(l){d.confirm(l[0],l[1],l[2],l[3],function(){require(["block_eduvidual/user"],function(m){m.setLandingPage(top.location.href)})})}).fail(d.exception)}else{require(["block_eduvidual/main"],function(l){l.connect({module:"user",act:"landingpage_set",url:k},{signalItem:c("#block_eduvidual_setlandingpage")})})}},showModuleInfo:function(k){var n=c(k).children("h3").html();var m=c(k).children("p").html();var l=c(k).attr("data-url");console.log(l);if(typeof l!=="undefined"&&l!=""){a.get_strings([{key:"open",component:"block_eduvidual"},{key:"close",component:"block_eduvidual"},]).done(function(o){d.confirm(n,m,o[0],o[1],function(){require(["block_eduvidual/main"],function(p){p.navigate(l)})})}).fail(d.exception)}else{d.alert(n,m)}},toggleSubmenu:function(k){if(typeof k!=="undefined"){if(k){c(".block_eduvidual_submenu_wrapper").addClass("opened")}else{c(".block_eduvidual_submenu_wrapper").removeClass("opened")}}else{c(".block_eduvidual_submenu_wrapper").toggleClass("opened")}},setHidden:function(l){var k=c(l).parent();var n=+k.attr("data-courseid");var m=k.hasClass("inactive");require(["block_eduvidual/main"],function(o){o.connect({module:"user",act:"courselist_sethidden",courseid:n,setto:(m)?0:1},{li:k})})},result:function(p){if(p.data.act=="accesscode"){if(p.result.status=="ok"){top.location.href=f.fileUrl("/blocks/eduvidual/pages/categories.php","")+"?orgid="+p.result.orgid}}if(p.data.act=="autologin"){var k=p.result.autologinurl+"/?userid="+p.result.userid+"&key="+p.result.key+"&urltogo="+encodeURI(p.payload.href);console.log("Navigating to ",k);window.open(k,"_blank")}if(p.data.act=="categories"){if(p.result.status=="ok"){var l=c(".ul-eduvidual-courses").empty();c(".block_eduvidual_courses_title").html(p.result.category.name);c(".ul-eduvidual-courses").attr("data-categoryid",p.data.categoryid);var v=c("<div>").addClass("grid-eq-2").css("text-align","center");l.append(v);a.get_strings([{key:"back",component:"block_eduvidual"},{key:"action",component:"block_eduvidual"},{key:"createcourse:here",component:"block_eduvidual"},{key:"createcategory:here",component:"block_eduvidual"},{key:"createcategory:rename",component:"block_eduvidual"},{key:"createcategory:remove",component:"block_eduvidual"},]).done(function(z){var A=c("<div>");var o=c("<a>").addClass("ui-btn btn btn-_secondary").attr("onclick","history.go(-1);").html(z[0]);if(typeof p.result.parent!=="undefined"&&p.result.parent.id>0){o.attr("onclick",'require(["block_eduvidual/user"], function(USER) { USER.loadCategory('+p.result.parent.id+"); });").html(p.result.parent.name)}o.html('<img src="/pix/t/left.svg" alt=""> '+o.html());A.append(o);v.append(A);var B=c("<select>").attr("data-role","selectmenu").attr("onchange",'var sel = this; require(["block_eduvidual/user"], function(USER) { USER.actionCategories(sel); });');B.append(c('<option value="">'+z[1]+"</option>"));if(["Manager","Teacher"].indexOf(p.result.orgrole)>-1||p.result.role=="Administrator"){B.append(c('<option value="createcourse">'+z[2]+"</option>"))}if(["Manager"].indexOf(p.result.orgrole)>-1||p.result.role=="Administrator"){B.append(c('<option value="createcategory">'+z[3]+"</option>"));if(p.result.orgcategoryid!=p.data.categoryid){B.append(c('<option value="editcategory">'+z[4]+"</option>"));B.append(c('<option value="removecategory">'+z[5]+"</option>"))}}if(B.children().length>1){v.append(B)}}).fail(d.exception);if(p.result.categories.length>0){var u=c("<ul>").attr("data-role","listview").attr("data-inset","true").attr("data-split-icon","plus").addClass("ui-listview ui-listview-inset ui-corner-all ui-shadow");for(var w=0;w<p.result.categories.length;w++){var n=p.result.categories[w];var x=c("<li>");if(w==0){x.addClass("ui-first-child")}var m=c("<a>").attr("href","#").attr("onclick",'require(["block_eduvidual/user"], function(USER) { USER.loadCategory('+n.id+"); });").addClass("ui-btn btn");if(n.visible==0){m.addClass("disabled").css("color","darkgray")}var r=c("<img>").attr("src","/pix/i/withsubcat.svg").attr("alt","Course category").css("display","inline-block");var t=c("<h3>").html(n.name).css("line-height","2.5em").css("display","inline").css("margin-left","5px");x.append(m.append([r,t]));u.append(x)}l.append(u)}if(p.result.courses.length>0){var q=localStorage.getItem("block_eduvidual_isembedded")!==null&&localStorage.getItem("block_eduvidual_isembedded")==1;var u=c("<ul>").attr("data-role","listview").attr("data-inset","true").addClass("ui-listview ui-listview-inset ui-corner-all ui-shadow");for(var w=0;w<p.result.courses.length;w++){var s=p.result.courses[w];var x=c("<li>");if(s.visible==0){x.addClass("block_eduvidual_inactive")}if(w==0){x.addClass("ui-first-child")}var k=f.fileUrl("/course/view.php","")+"?id="+s.id;var y="";if(q){k="#";y='require(["block_eduvidual/jquery-ba-postmessage"], function(p) { p.post("open_course|'+s.id+'"); });'}var r=c("<img>").attr("src",(s.image!="")?s.image:"/pix/i/course.svg").attr("alt","Course");var m=c("<a>").attr("href",k).attr("onclick",y).attr("data-ajax","false").addClass("ui-btn btn");var t=c("<h3>").html(s.fullname).css("line-height","2.5em").css("display","inline").css("margin-left","5px");u.append(x.append(m.append([r,t])))}l.append(u)}}else{l.append(c("<li>").html("ERROR"))}}if(p.data.act=="courselist_sethidden"){if(p.data.setto){c(p.payload.li).addClass("inactive ishidden")}else{c(p.payload.li).removeClass("inactive ishidden")}}if(p.data.act=="whoami"||p.data.act=="login"){if(p.result.status=="ok"){if(p.payload.urltogo.indexOf("/pages/login_app.php")>0){console.log("This is the login page in app-mode - going to my courses");p.payload.urltogo=f.fileUrl("/blocks/eduvidual/pages/courses.php","")}require(["block_eduvidual/main"],function(o){o.resume(p.payload.urltogo,p.result.userid)})}else{c("#block_eduvidual_overlay").remove()}}},showShibboleth:function(){var k=f.fileUrl("/auth/shibboleth_link","login.php?embed=1");console.log("popPage ",k);c.get(k).done(function(l){console.log("Got body ",l);h.create({title:"edu.IDAM",body:l,}).done(function(m){console.log("Created modal");m.show()})}).fail(function(l){console.err("Error",l)})},}});